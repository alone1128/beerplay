<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>é…’è´¦&æ¸¸æˆæµ·æŠ¥ç°¿</title>
<script src="https://cdn.jsdelivr.net/npm/qr-creator/dist/qr-creator.min.js"></script>
<style>
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;margin:0;background:#fafafa;color:#333}
h1{text-align:center;font-size:1.4rem;margin:.5rem 0}
input,select,button{font-size:1rem;padding:.4rem;margin:.2rem;border:1px solid #bbb;border-radius:4px}
.add-sec{display:flex;flex-wrap:wrap;gap:.3rem;margin:.8rem}
.card{background:#fff;border-radius:8px;padding:.6rem;margin:.4rem 0;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.card-header{display:flex;align-items:center;gap:.5rem}
.avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid #07c160}
.count{margin-left:auto;font-weight:700;font-size:1.2rem}
.level-bar{width:100%;height:10px;background:#e0e0e0;border-radius:5px;margin:.3rem 0;overflow:hidden}
.level-fill{height:100%;background:linear-gradient(90deg,#07c160,#ffc107,#ff6030)}
.games{color:#666;font-size:.9rem}
.note{color:#999;font-size:.85rem;margin-top:.2rem}
.ctrl{margin-top:.4rem;display:flex;gap:.3rem}
.ctrl button{padding:.3rem .6rem;border:none;border-radius:4px;color:#fff;cursor:pointer}
.plus{background:#07c160}
.minus{background:#fa5151}
.del{background:#333}
.poster-box{position:relative;width:300px;margin:1rem auto;background:#fff;border:1px solid #ddd;border-radius:8px;padding:1rem;text-align:center}
#posterQR{width:80px;height:80px;margin:.5rem auto}
#posterCanvas{display:none}
.toolbar{margin:.8rem;display:flex;gap:.5rem;flex-wrap:wrap}
</style>
</head>
<body>
<h1>ğŸ» é…’è´¦ & æ¸¸æˆæµ·æŠ¥ç°¿</h1>

<!-- æ–°å¢äººç‰© -->
<section class="add-sec">
  <input id="name" placeholder="å§“å">
  <input id="avatarFile" type="file" accept="image/*" capture="environment">
  <select id="level">
    <option value="å°è¶´èœ">å°è¶´èœ</option>
    <option value="è¿˜è¡Œ">è¿˜è¡Œ</option>
    <option value="é…’ç‹">é…’ç‹</option>
  </select>
  <input id="games" placeholder="æ“…é•¿æ¸¸æˆï¼Œé€—å·åˆ†éš”">
  <input id="note" placeholder="å¤‡æ³¨">
  <button onclick="addPerson()">æ·»åŠ </button>
</section>

<!-- å·¥å…·æ  -->
<div class="toolbar">
  <button onclick="exportJSON()">å¯¼å‡º JSON</button>
  <button onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨</button>
</div>

<!-- äººç‰©åˆ—è¡¨ -->
<div id="list"></div>

<!-- æµ·æŠ¥é¢„è§ˆï¼ˆç”Ÿæˆåæ˜¾ç¤ºï¼‰ -->
<div id="posterWrap" style="display:none">
  <div class="poster-box" id="posterBox"></div>
  <button onclick="savePoster()">ä¿å­˜æµ·æŠ¥åˆ°ç›¸å†Œ</button>
  <button onclick="shareTimeline()">åˆ†äº«åˆ°æœ‹å‹åœˆ</button>
</div>

<script>
/****************************************************
 *  å·¥å…·å‡½æ•°
 ***************************************************/
const $ = id => document.getElementById(id);
function loadData(){
  return JSON.parse(localStorage.getItem('beerGameFull')||'[]');
}
function saveData(arr){
  localStorage.setItem('beerGameFull',JSON.stringify(arr));
}

/****************************************************
 *  å¤´åƒè½¬ base64
 ***************************************************/
let avatarB64 = '';
$('avatarFile').addEventListener('change',e=>{
  const file = e.target.files[0];
  if(!file)return;
  const reader = new FileReader();
  reader.onload = ev => avatarB64 = ev.target.result;
  reader.readAsDataURL(file);
});

/****************************************************
 *  å¢åˆ æ”¹
 ***************************************************/
function addPerson(){
  const name = $('name').value.trim();
  if(!name)return alert('å¡«ä¸ªåå­—å§');
  const data = loadData();
  if(data.some(p=>p.name===name))return alert('å·²å­˜åœ¨');
  data.push({
    name,avatar:avatarB64||'ğŸ§‘',level:$('level').value,
    games:$('games').value,note:$('note').value,count:0
  });
  saveData(data);['name','games','note'].forEach(id=>$(id).value='');
  avatarB64='';$('avatarFile').value='';render();
}
function delPerson(idx){
  if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;
  const data = loadData();data.splice(idx,1);saveData(data);render();
}
function change(idx,delta){
  const data = loadData();
  data[idx].count = Math.max(0,data[idx].count+delta);saveData(data);render();
}

/****************************************************
 *  æ¸²æŸ“åˆ—è¡¨
 ***************************************************/
function render(){
  const arr = loadData();
  const listEl = $('list');listEl.innerHTML='';
  arr.forEach((p,i)=>{
    const card = document.createElement('div');card.className='card';
    const levelPercent = {å°è¶´èœ:30,è¿˜è¡Œ:60,é…’ç‹:100}[p.level]||0;
    card.innerHTML=`
      <div class="card-header">
        ${p.avatar.startsWith('data:')?`<img class="avatar" src="${p.avatar}">`: `<span class="avatar">${p.avatar}</span>`}
        <div>
          <div>${p.name}</div>
          <div class="level-bar"><div class="level-fill" style="width:${levelPercent}%"></div></div>
        </div>
        <div class="count">ğŸ» ${p.count}</div>
      </div>
      <div class="games">æ“…é•¿ï¼š${p.games||'æ— '}</div>
      <div class="note">å¤‡æ³¨ï¼š${p.note||'æ— '}</div>
      <div class="ctrl">
        <button class="plus" onclick="change(${i},1)">+1</button>
        <button class="minus" onclick="change(${i},-1)">-1</button>
        <button class="del" onclick="delPerson(${i})">åˆ é™¤</button>
        <button onclick="genPoster(${i})">ç”Ÿæˆæµ·æŠ¥</button>
      </div>`;
    listEl.appendChild(card);
  });
}

/****************************************************
 *  ä¸€é”®æµ·æŠ¥ï¼ˆå«äºŒç»´ç ï¼‰
 ***************************************************/
function genPoster(i){
  const p = loadData()[i];
  const url = `${location.origin}${location.pathname}?name=${encodeURIComponent(p.name)}`; // å¯æ‰«ç å›åˆ°æ­¤äººé¡µ
  $('posterBox').innerHTML=`
    <h2>ğŸ» é…’è´¦æµ·æŠ¥</h2>
    ${p.avatar.startsWith('data:')?`<img class="avatar" src="${p.avatar}">`: `<span class="avatar">${p.avatar}</span>`}
    <div><b>${p.name}</b></div>
    <div>é…’é‡ç­‰çº§ï¼š${p.level}</div>
    <div>å½“å‰æ¬ é…’ï¼š<b style="color:#07c160">${p.count} ç“¶</b></div>
    <div>æ“…é•¿æ¸¸æˆï¼š${p.games||'æ— '}</div>
    <div id="posterQR"></div>
    <div style="font-size:12px;color:#999">æ‰«ç æŸ¥çœ‹å®æ—¶è´¦æœ¬</div>`;
  // ç”ŸæˆäºŒç»´ç 
  QRCreator(url,{size:80},q=> $('posterQR').appendChild(q));
  $('posterWrap').style.display='block';
  // æŠŠæµ·æŠ¥ç”»åˆ°éšè— canvasï¼Œæ–¹ä¾¿ä¿å­˜
  const canvas = document.createElement('canvas');canvas.width=300;canvas.height=350;
  const ctx=canvas.getContext('2d');
  ctx.fillStyle='#fff';ctx.fillRect(0,0,300,350);
  ctx.fillStyle='#000';ctx.font='20px sans-serif';ctx.textAlign='center';
  ctx.fillText('ğŸ» é…’è´¦æµ·æŠ¥',150,40);
  const img=new Image();
  img.onload=()=>{ctx.drawImage(img,100,60,100,100);ctx.font='16px sans-serif';
  ctx.fillText(p.name,150,190);ctx.fillText(`é…’é‡ç­‰çº§ï¼š${p.level}`,150,220);
  ctx.fillText(`å½“å‰æ¬ é…’ï¼š${p.count} ç“¶`,150,250);ctx.fillText(`æ“…é•¿ï¼š${p.games||'æ— '}`,150,280);
  ctx.drawImage($('posterQR').querySelector('canvas'),110,290,80,80);
  document.body.appendChild(canvas);canvas.id='posterCanvas';};
  img.src=p.avatar.startsWith('data:')?p.avatar:'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
}
function savePoster(){
  const canvas=$('posterCanvas');
  if(!canvas)return alert('è¯·å…ˆç”Ÿæˆæµ·æŠ¥');
  canvas.toBlob(blob=>{
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download='beerPoster.png';a.click();
  });
}
function shareTimeline(){
  // å¾®ä¿¡å†…åµŒæµè§ˆå™¨å¯ç›´æ¥è°ƒèµ·åˆ†äº«ï¼›å…¶ä½™æµè§ˆå™¨å¤åˆ¶æ–‡æ¡ˆ
  const text='å¿«æ¥çœ‹çœ‹æˆ‘çš„é…’è´¦æµ·æŠ¥~ '+location.href;
  if(typeof WeixinJSBridge!=='undefined'){
    WeixinJSBridge.invoke('shareTimeline',{title:text,link:location.href});
  }else{
    alert('å·²ç”Ÿæˆæµ·æŠ¥ï¼Œè¯·æ‰‹åŠ¨åˆ†äº«åˆ°æœ‹å‹åœˆ\n'+text);
  }
}

/****************************************************
 *  å·¥å…·æ 
 ***************************************************/
function exportJSON(){
  const blob=new Blob([localStorage.getItem('beerGameFull')],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='beerGameFull.json';a.click();
}
function clearAll(){
  if(!confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ'))return;
  localStorage.removeItem('beerGameFull');render();
}

/****************************************************
 *  åˆå§‹åŒ–
 ***************************************************/
render();
</script>
</body>
</html>
